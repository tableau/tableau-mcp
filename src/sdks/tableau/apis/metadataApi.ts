import { makeApi, makeEndpoint, ZodiosEndpointDefinitions } from '@zodios/core';
import { z } from 'zod';

export const graphqlResponse = z.object({
  data: z.object({
    publishedDatasources: z.array(
      z.object({
        name: z.string().or(z.null()),
        description: z.string().or(z.null()),
        owner: z.object({
          name: z.string().or(z.null()),
        }),
        fields: z.array(
          z.object({
            name: z.string(),
            isHidden: z.boolean().or(z.null()),
            description: z.string().or(z.null()),
            descriptionInherited: z
              .array(
                z
                  .object({
                    attribute: z.string(),
                    value: z.string().or(z.null()),
                  })
                  .or(z.null()),
              )
              .or(z.null()),
            fullyQualifiedName: z.string(),
            __typename: z.string(),
            // Common field properties (optional since they depend on field type)
            dataCategory: z.string().or(z.null()).optional(),
            role: z.string().or(z.null()).optional(),
            dataType: z.string().or(z.null()).optional(),
            defaultFormat: z.string().or(z.null()).optional(),
            semanticRole: z.string().or(z.null()).optional(),
            aggregation: z.string().or(z.null()).optional(),
            aggregationParam: z.string().or(z.null()).optional(),
            // CalculatedField specific properties
            formula: z.string().or(z.null()).optional(),
            isAutoGenerated: z.boolean().or(z.null()).optional(),
            hasUserReference: z.boolean().or(z.null()).optional(),
            // BinField specific properties
            binSize: z.number().or(z.null()).optional(),
            // GroupField specific properties
            hasOther: z.boolean().or(z.null()).optional(),
            // CombinedSetField specific properties
            delimiter: z.string().or(z.null()).optional(),
            combinationType: z.string().or(z.null()).optional(),
          }),
        ),
      }),
    ),
  }),
});

export type GraphQLResponse = z.infer<typeof graphqlResponse>;

const graphqlEndpoint = makeEndpoint({
  method: 'post',
  path: '/graphql',
  alias: 'graphql',
  response: graphqlResponse,
  parameters: [
    {
      name: 'query',
      type: 'Body',
      schema: z.object({
        query: z.string(),
      }),
    },
  ],
});

const metadataApi = makeApi([graphqlEndpoint]);
export const metadataApis = [...metadataApi] as const satisfies ZodiosEndpointDefinitions;
